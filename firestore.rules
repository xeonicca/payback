rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is trip collaborator
    function isCollaborator(tripId) {
      return exists(/databases/$(database)/documents/trips/$(tripId)/collaborators/$(request.auth.uid));
    }

    // Helper function to check if user is trip owner
    function isOwner(tripId) {
      return get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid;
    }

    // Trips collection
    match /trips/{tripId} {
      // Anyone authenticated can create their own trip
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Users can read trips they own or collaborate on
      // For list queries: check if userId matches (for owned trips)
      // For individual reads: check owner or collaborator
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || isCollaborator(tripId));

      // Only owner can update/delete trip settings
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // Collaborators subcollection
      match /collaborators/{userId} {
        // Owners and collaborators can read the collaborator list
        allow read: if request.auth != null &&
          (get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
           isCollaborator(tripId));

        // Only owner can manage collaborators
        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid;
      }

      // Members subcollection
      match /members/{memberId} {
        // Owners and collaborators can read members
        allow read: if request.auth != null &&
          (get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
           isCollaborator(tripId));

        // Only owner can manage trip members
        allow create, update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid;
      }

      // Expenses subcollection
      match /expenses/{expenseId} {
        // Owners and collaborators can read expenses
        allow read: if request.auth != null &&
          (get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
           isCollaborator(tripId));

        // Both owners and collaborators can manage expenses
        allow create, update, delete: if request.auth != null &&
          (get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
           isCollaborator(tripId));
      }
    }

    // Invitations collection
    match /invitations/{invitationId} {
      // Anyone authenticated can read invitations (needed to accept them)
      allow read: if request.auth != null;

      // Only trip owner can create invitations
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/trips/$(request.resource.data.tripId)).data.userId == request.auth.uid;

      // Only trip owner can update/delete invitations
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/trips/$(resource.data.tripId)).data.userId == request.auth.uid;
    }
  }
}
